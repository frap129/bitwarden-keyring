# Noctalia UI Integration Plan for bitwarden-keyring

## Overview

Add a Noctalia UI hook to bitwarden-keyring that integrates with the existing `noctalia-polkit-agent` service for password prompts. This enables native Noctalia panel-based authentication dialogs when unlocking the Bitwarden vault.

## Architecture Decision

**Approach**: Integrate bitwarden-keyring as an IPC client to the existing `noctalia-polkit-agent` daemon using its keyring request mechanism.

**Rationale**:
- The noctalia-polkit-agent already supports `keyring_request` messages (used by gcr-prompter replacement)
- Opt-in via `--noctalia` flag - disabled by default to avoid unexpected behavior
- When enabled, Noctalia is first priority; falls back to existing prompts if socket unavailable
- Includes a dedicated Noctalia plugin for branded Bitwarden UI

## Protocol Reference

**Socket**: `$XDG_RUNTIME_DIR/noctalia-polkit-agent.sock` (Unix domain socket)  
**Format**: Newline-delimited JSON (one JSON object per line, terminated by `\n`)

### Two Independent Communication Flows

There are two separate socket connections that work together:

#### Flow 1: bitwarden-keyring (Go IPC Client)
The Go client connects, sends a request, and **keeps the connection open** until it receives a response.

**Request** (bitwarden-keyring → agent):
```json
{"type":"keyring_request","cookie":"unique-request-id","title":"Bitwarden Keyring","message":"Enter Master Password","description":"","password_new":false,"confirm_only":false}
```

**Response** (agent → bitwarden-keyring, on same socket):
```json
{"type":"keyring_response","id":"unique-request-id","result":"ok","password":"user-entered-password"}
```

Possible `result` values:
- `"ok"` - password provided (includes `password` field)
- `"cancelled"` - user cancelled (no `password` field)
- `"confirmed"` - user confirmed (for `confirm_only:true`, no `password` field)

#### Flow 2: Noctalia Plugin (QML UI Frontend)
The plugin uses **separate short-lived connections** to poll for events and submit responses.

**Poll for events** (plugin → agent):
```json
{"type":"next"}
```

**Event response** (agent → plugin):
```json
{"type":"request","source":"keyring","id":"unique-request-id","message":"Bitwarden Keyring","prompt":"Enter Master Password","description":"","echo":false,"passwordNew":false,"confirmOnly":false}
```
Or `{"type":"empty"}` if no pending requests.

**Submit password** (plugin → agent, new connection):
```json
{"type":"respond","id":"unique-request-id","response":"user-entered-password"}
```

**Cancel request** (plugin → agent, new connection):
```json
{"type":"cancel","id":"unique-request-id"}
```

**Completion event** (agent → plugin, via next poll):
```json
{"type":"complete","id":"unique-request-id","result":"success"}
```

### Field Mapping (keyring_request → UI event)
| keyring_request field | UI event field |
|-----------------------|----------------|
| `title` | `message` |
| `message` | `prompt` |
| `description` | `description` |
| `cookie` | `id` |
| `password_new` | `passwordNew` |
| `confirm_only` | `confirmOnly` |
| (added by agent) | `source: "keyring"` |

---

## Implementation Tasks

### Phase 1: Core Noctalia IPC Client

#### 1.1 Create package structure
Create new package `internal/noctalia/` with:
- `types.go` - Message struct definitions
- `client.go` - Unix socket IPC client
- `client_test.go` - Unit tests

#### 1.2 Define message types
**File**: `internal/noctalia/types.go` (new)

```go
package noctalia

type KeyringRequest struct {
    Type        string `json:"type"`         // "keyring_request"
    Cookie      string `json:"cookie"`       // unique ID (UUID)
    Title       string `json:"title"`        // "Bitwarden Keyring"
    Message     string `json:"message"`      // "Enter Master Password"
    Description string `json:"description"`  // optional
    PasswordNew bool   `json:"password_new"` // false
    ConfirmOnly bool   `json:"confirm_only"` // false
}

type KeyringResponse struct {
    Type     string `json:"type"`     // "keyring_response"
    ID       string `json:"id"`       // matches cookie
    Result   string `json:"result"`   // "ok", "cancelled", or "confirmed"
    Password string `json:"password"` // only if result="ok"
}

// Error types
var (
    ErrSocketNotFound   = errors.New("noctalia socket not found")
    ErrConnectionFailed = errors.New("failed to connect to noctalia agent")
    ErrTimeout          = errors.New("noctalia request timed out")
    ErrCancelled        = errors.New("user cancelled password prompt")
    ErrConfirmOnly      = errors.New("confirm-only request acknowledged")  // Not an error per se
    ErrProtocolError    = errors.New("noctalia protocol error")
    ErrCookieMismatch   = errors.New("response cookie does not match request")
)
```

#### 1.3 Implement Unix socket client
**File**: `internal/noctalia/client.go` (new)

Key implementation details:
- Socket path: `filepath.Join(os.Getenv("XDG_RUNTIME_DIR"), "noctalia-polkit-agent.sock")`
- Fallback: `/run/user/<uid>/noctalia-polkit-agent.sock`
- Connect timeout: 5 seconds
- **Keep connection open** after sending request until response received
- Read timeout: 120 seconds (user needs time to type password)
- Cookie generation: 16 random bytes hex-encoded (no external deps)

```go
package noctalia

type Client struct {
    socketPath string
    timeout    time.Duration
}

func NewClient(opts ...Option) *Client
func (c *Client) IsAvailable() bool  // Check if socket exists
func (c *Client) RequestPassword(ctx context.Context, title, message string) (string, error)

// generateCookie returns 16 random bytes as hex string (32 chars)
func generateCookie() (string, error)
```

**RequestPassword implementation notes**:
1. Connect to Unix socket
2. Generate unique cookie
3. Write JSON request + newline, flush
4. **Do not close connection** - wait for response
5. Read response line (blocking, with timeout from context)
6. Parse JSON, validate cookie matches
7. Return password or error based on result

#### 1.4 Integrate into SessionManager
**File**: `internal/bitwarden/session.go`
**Lines to modify**: ~102-131 (PromptForPassword method)

Changes:
1. Add import for `internal/noctalia`
2. Add `noctaliaEnabled bool` and `noctaliaClient *noctalia.Client` fields to `SessionManager`
3. Add `promptNoctalia()` method - only called when `--noctalia` flag is set

New fallback order (when `--noctalia` enabled):
```
1. Noctalia (first priority when --noctalia flag set)
2. zenity (GTK)
3. kdialog (KDE/Qt)
4. rofi
5. dmenu
6. systemd-ask-password
```

Default fallback order (without `--noctalia`):
```
1. zenity (GTK)
2. kdialog (KDE/Qt)
3. rofi
4. dmenu
5. systemd-ask-password
```

---

### Phase 2: Configuration & CLI Flags

#### 2.1 Add command-line flags
**File**: `cmd/bitwarden-keyring/main.go`
**Lines to modify**: ~17-21 (flag definitions)

New flags:
```go
noctalia        = flag.Bool("noctalia", false, "Enable Noctalia UI integration for password prompts")
noctaliaSocket  = flag.String("noctalia-socket", "", "Custom Noctalia socket path (default: $XDG_RUNTIME_DIR/noctalia-polkit-agent.sock)")
noctaliaTimeout = flag.Duration("noctalia-timeout", 120*time.Second, "Noctalia prompt timeout")
```

**Behavior**:
- Without `--noctalia`: Uses standard fallback chain (zenity, kdialog, rofi, dmenu, systemd-ask-password)
- With `--noctalia`: Tries Noctalia first, falls back to standard chain if socket unavailable

#### 2.2 Pass config to SessionManager
**File**: `internal/bitwarden/session.go`

Add configuration struct:
```go
type SessionConfig struct {
    NoctaliaEnabled bool          // Set by --noctalia flag
    NoctaliaSocket  string        // Optional override for socket path
    NoctaliaTimeout time.Duration // Timeout for password prompt
}

func NewSessionManager(cfg SessionConfig) *SessionManager
```

---

### Phase 3: Testing & Documentation

#### 3.1 Unit tests
**File**: `internal/noctalia/client_test.go` (new)

Test cases:
- `TestIsAvailable_SocketExists` - returns true when socket exists
- `TestIsAvailable_SocketMissing` - returns false when no socket
- `TestRequestPassword_Success` - mock server returns password
- `TestRequestPassword_Cancelled` - mock server returns cancelled
- `TestRequestPassword_Timeout` - connection times out
- `TestRequestPassword_InvalidJSON` - handles malformed response

#### 3.2 Mock server for testing
**File**: `internal/noctalia/testutil/mock_server.go` (new)

```go
type MockServer struct {
    listener net.Listener
}

func NewMockServer(socketPath string) (*MockServer, error)
func (m *MockServer) RespondWith(response KeyringResponse)
func (m *MockServer) Close()
```

#### 3.3 Integration test
**File**: `internal/bitwarden/session_test.go`

- Test fallback behavior when Noctalia unavailable
- Test Noctalia takes priority when available

#### 3.4 Update documentation
**File**: `README.md`

Add section:
```markdown
## Noctalia Integration

bitwarden-keyring supports Noctalia for native panel-based password prompts.

### Enable Noctalia
```bash
bitwarden-keyring --noctalia
```

### Requirements
- noctalia-polkit-agent running (from noctalia-unofficial-auth-agent)
- Socket at $XDG_RUNTIME_DIR/noctalia-polkit-agent.sock

### Optional: Dedicated Plugin
For a branded Bitwarden experience, install the Noctalia plugin:
```bash
cp -r noctalia-plugin ~/.local/share/noctalia/plugins/bitwarden-keyring
```
Then enable the plugin in Noctalia settings.

### Fallback Behavior
When `--noctalia` is set but the agent is unavailable, bitwarden-keyring falls back
to standard prompts (zenity, kdialog, rofi, dmenu, systemd-ask-password).
```

---

### Phase 4: Dedicated Noctalia Plugin

Create a branded Bitwarden-specific Noctalia plugin for enhanced UI integration.

#### 4.1 Create plugin structure
**Directory**: `noctalia-plugin/`

```
noctalia-plugin/
├── manifest.json       # Plugin metadata
├── Main.qml           # Main logic, socket communication
├── AuthDialog.qml     # Password dialog UI component
├── Panel.qml          # Panel attachment configuration
├── Settings.qml       # Plugin settings UI
├── assets/
│   └── bitwarden.svg  # Bitwarden icon
└── README.md          # Installation instructions
```

#### 4.2 Plugin manifest
**File**: `noctalia-plugin/manifest.json`

```json
{
  "id": "bitwarden-keyring",
  "name": "Bitwarden Keyring",
  "version": "0.1.0",
  "minNoctaliaVersion": "3.6.0",
  "author": "bitwarden-keyring",
  "license": "MIT",
  "description": "Password prompts for Bitwarden Keyring vault unlock",
  "entryPoints": {
    "main": "Main.qml",
    "panel": "Panel.qml",
    "settings": "Settings.qml"
  },
  "metadata": {
    "defaultSettings": {
      "timeout": 120,
      "showBitwardenIcon": true,
      "autoCloseOnSuccess": true
    }
  }
}
```

#### 4.3 Main.qml implementation
**File**: `noctalia-plugin/Main.qml`

Key features:
- Connect to `$XDG_RUNTIME_DIR/noctalia-polkit-agent.sock`
- Poll via `{"type":"next"}` on a timer (e.g., 100ms interval)
- Filter events where `source === "keyring"` (ignore polkit requests)
- Optionally filter by `message` containing "Bitwarden" to only handle this app's requests
- Display password dialog via AuthDialog.qml when request received
- Send `{"type":"respond","id":requestId,"response":password}` on submit
- Send `{"type":"cancel","id":requestId}` on cancel/timeout
- Listen for `{"type":"complete"}` events to close dialog

**Important**: This plugin does NOT send `keyring_response` directly. It sends `respond`/`cancel` commands, and the agent forwards `keyring_response` to the original bitwarden-keyring socket.

#### 4.4 AuthDialog.qml
**File**: `noctalia-plugin/AuthDialog.qml`

UI components:
- Bitwarden icon/branding (from assets/bitwarden.svg)
- Title: bound to `request.message` (maps from keyring_request.title)
- Message: bound to `request.prompt` (maps from keyring_request.message)
- Password input field (masked, `echo: false`)
- Submit/Cancel buttons
- Error state display
- Loading state while response in flight

#### 4.5 Settings.qml
**File**: `noctalia-plugin/Settings.qml`

Configurable options:
- Timeout duration slider
- Show/hide Bitwarden icon toggle
- Auto-close on success toggle

---

## Service Activation

Since bitwarden-keyring is typically started via D-Bus activation or systemd, users need a way to pass the `--noctalia` flag.

### Option 1: Systemd User Override (Recommended)
Create a drop-in override file:

```bash
mkdir -p ~/.config/systemd/user/bitwarden-keyring.service.d/
cat > ~/.config/systemd/user/bitwarden-keyring.service.d/noctalia.conf << 'EOF'
[Service]
ExecStart=
ExecStart=/usr/bin/bitwarden-keyring --noctalia
EOF
systemctl --user daemon-reload
```

### Option 2: D-Bus Service Override
Copy and modify the D-Bus service file:

```bash
mkdir -p ~/.local/share/dbus-1/services/
cp /usr/share/dbus-1/services/org.freedesktop.secrets.service ~/.local/share/dbus-1/services/
sed -i 's|Exec=/usr/bin/bitwarden-keyring|Exec=/usr/bin/bitwarden-keyring --noctalia|' \
    ~/.local/share/dbus-1/services/org.freedesktop.secrets.service
```

### Option 3: Environment Variable (Alternative)
Add support for `BITWARDEN_KEYRING_NOCTALIA=1` environment variable as an alternative to the flag. This can be set in `~/.config/environment.d/` or shell profile.

**Files to update for Option 3**:
- `cmd/bitwarden-keyring/main.go`: Check `os.Getenv("BITWARDEN_KEYRING_NOCTALIA")` in addition to flag

---

## Files to Modify/Create

| File | Action | Description |
|------|--------|-------------|
| `internal/noctalia/types.go` | **Create** | Message types and errors |
| `internal/noctalia/client.go` | **Create** | Unix socket IPC client |
| `internal/noctalia/client_test.go` | **Create** | Unit tests |
| `internal/noctalia/testutil/mock_server.go` | **Create** | Mock server for tests |
| `internal/bitwarden/session.go` | **Modify** | Add Noctalia prompt method (opt-in via flag) |
| `internal/bitwarden/client.go` | **Modify** | Pass config to SessionManager |
| `cmd/bitwarden-keyring/main.go` | **Modify** | Add `--noctalia` flag and related options |
| `README.md` | **Modify** | Document Noctalia integration |
| `noctalia-plugin/manifest.json` | **Create** | Plugin metadata |
| `noctalia-plugin/Main.qml` | **Create** | Plugin logic and socket communication |
| `noctalia-plugin/AuthDialog.qml` | **Create** | Password dialog UI |
| `noctalia-plugin/Panel.qml` | **Create** | Panel attachment config |
| `noctalia-plugin/Settings.qml` | **Create** | Plugin settings UI |
| `noctalia-plugin/README.md` | **Create** | Plugin installation instructions |

---

## Verification

### Manual Testing

1. **With --noctalia flag and agent running**:
   ```bash
   # Start the agent
   systemctl --user start noctalia-polkit.service
   
   # Start bitwarden-keyring with Noctalia enabled
   ./bitwarden-keyring --noctalia
   
   # Trigger a password prompt (e.g., access a secret via libsecret)
   secret-tool lookup service test
   
   # Expected: Noctalia panel appears for password entry
   ```

2. **With --noctalia flag but agent not running**:
   ```bash
   systemctl --user stop noctalia-polkit.service
   ./bitwarden-keyring --noctalia
   secret-tool lookup service test
   
   # Expected: Falls back to zenity/kdialog/etc. (with log message about Noctalia unavailable)
   ```

3. **Without --noctalia flag (default)**:
   ```bash
   ./bitwarden-keyring
   secret-tool lookup service test
   
   # Expected: Uses standard fallback chain (zenity, kdialog, rofi, dmenu, systemd-ask-password)
   ```

4. **Test Noctalia plugin**:
   ```bash
   # Install plugin to Noctalia plugins directory
   cp -r noctalia-plugin ~/.local/share/noctalia/plugins/bitwarden-keyring
   
   # Restart Noctalia and enable the plugin
   # Trigger password prompt - should show Bitwarden-branded dialog
   ```

### Automated Testing

```bash
# Run unit tests
go test ./internal/noctalia/...

# Run integration tests
go test ./internal/bitwarden/... -tags=integration
```

---

## Dependencies

No new Go dependencies required - uses standard library only:
- `net` for Unix socket
- `encoding/json` for JSON marshaling
- `crypto/rand` for cookie generation
- `context` for timeout handling

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Agent not running | Auto-detect socket, fall back gracefully |
| Socket permissions | Document requirements, check access |
| Protocol changes | Defensive JSON parsing, version checks |
| Password exposure | Clear password bytes after use |
| Blocking main thread | Use context with timeout |

---

## D-Bus Error Semantics

When the user cancels the Noctalia prompt (or it times out), bitwarden-keyring should return the same D-Bus error as it does for other cancelled prompts. Currently `PromptForPassword()` in `session.go` returns an error that propagates up and causes the vault to remain locked.

**Behavior to preserve**:
- On cancel/timeout: Return `ErrCancelled` from `promptNoctalia()`, which causes `PromptForPassword()` to try the next fallback method
- If all methods fail: Return final error to D-Bus caller
- The existing D-Bus methods (`GetSecrets`, `CreateItem`, `Prompt`) already handle unlock failures appropriately

**No changes needed** to D-Bus error handling - just ensure `noctalia.ErrCancelled` triggers fallback to next prompt method.
