# Plan: Replace Polling with SocketServer in Noctalia Plugin

## Current State

The noctalia-plugin polls a socket every 100ms to check for pending password requests:

**Key files:**
- `noctalia-plugin/Main.qml:239-244` - Poll timer (100ms interval)
- `noctalia-plugin/Main.qml:78-103` - `pollRequests()` function
- `internal/noctalia/client.go` - Go IPC client (connects to socket)
- `internal/noctalia/types.go` - Request/response message types

**Current flow:**
```
bitwarden-keyring (Go)  ---connect--->  some socket  <---poll---  noctalia-plugin
```

## Proposed Solution: SocketServer

Invert the architecture so the Quickshell plugin acts as a socket server and bitwarden-keyring connects directly to it:

```
bitwarden-keyring (Go)  ---connect & push--->  noctalia-plugin (SocketServer)
                        <---password response---
```

**Benefits:**
- True push-based - no polling required
- Instant UI response when password is needed
- Lower resource usage
- Simpler architecture

---

## Implementation Plan

### 1. Update QML Plugin to Use SocketServer

**File:** `noctalia-plugin/Main.qml`

- Replace `Socket` (client) with `SocketServer` (server)
- Socket path: `$XDG_RUNTIME_DIR/noctalia-keyring.sock`
- Remove polling timers (`pollTimer`, `pingTimer`)
- Handle incoming connections and push events via `SplitParser.onRead`
- Store connection reference to send response back on same connection

**New pattern:**
```qml
SocketServer {
    active: true
    path: root.socketPath
    handler: Socket {
        parser: SplitParser {
            onRead: function(line) {
                // Handle incoming request, show dialog
                var request = JSON.parse(line)
                handleKeyringRequest(request, this.parent)
            }
        }
    }
}
```

### 2. Update Go Client

**Files:** `internal/noctalia/client.go`, `internal/noctalia/types.go`

- Change default socket name from `noctalia-polkit-agent.sock` to `noctalia-keyring.sock`
- Update package/comment documentation to remove external agent references
- Protocol remains the same (newline-delimited JSON)

### 3. Update Documentation and Settings

**Files:**
- `noctalia-plugin/manifest.json` - Remove `pollInterval` from defaultSettings
- `noctalia-plugin/Settings.qml` - Remove poll interval setting
- `noctalia-plugin/README.md` - Update architecture description

---

## Detailed Changes

### Main.qml Changes

1. **Remove polling infrastructure:**
   - Delete `pollTimer` (lines 239-244)
   - Delete `pingTimer` (lines 247-253)
   - Delete `pollRequests()` function (lines 78-103)
   - Delete `agentAvailable`, `agentStatus` properties

2. **Add SocketServer:**
   - Create `SocketServer` with path `$XDG_RUNTIME_DIR/noctalia-keyring.sock`
   - Handle incoming connections
   - Store active connection for responses

3. **Update socket path:**
   - Change from `noctalia-polkit-agent.sock` to `noctalia-keyring.sock`

4. **Update response handling:**
   - `submitPassword()` writes to the original connection
   - `cancelRequest()` sends cancel message and closes connection

### client.go Changes

1. Update `DefaultSocketName` constant: `"noctalia-keyring.sock"`
2. Update comments to reflect direct plugin communication
3. No protocol changes needed

### types.go Changes

1. Update package documentation comment

---

## Verification

1. **Build and run bitwarden-keyring with `--noctalia` flag**
2. **Verify plugin creates socket at `$XDG_RUNTIME_DIR/noctalia-keyring.sock`**
3. **Trigger a password prompt (e.g., `bw unlock`)**
4. **Confirm dialog appears immediately (no 100ms polling delay)**
5. **Submit password and verify authentication succeeds**
6. **Test cancel flow**
7. **Run existing tests:** `go test ./internal/noctalia/...`
